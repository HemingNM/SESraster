---
title: "Introduction to SESraster"
author: "Neander Heming, Flávio Mota and Gabriela Alves-Ferreira"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to SESraster}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib
# csl: restoration-ecology.csl
# biblio-style: apelike
link-citations: false
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

-   [Introduction](#intro)
-   [Installation](#install)
-   [Analysis](#analysis)
-   [References](#references)

## Introduction {#intro}

Species distributions are dynamic and ever-changing, exhibiting variations both across time and space. To study and understand the complex mechanisms underlying species distributions and the structure of biological communities, null models are often used. A null model is a simplified representation of how species distributions would look if specific ecological processes or factors were not operating. The package [`SESraster`](https://github.com/HemingNM/SESraster) covers a current gap by offering functions for randomization of presence/absence raster data with or without including spatial structure on randomized patterns of species distribution.

## Installation {#install}

```{r, eval = FALSE}
install.packages("SESraster")
library(SESraster)
```

If you find any bug, let us know through [SESraster Issues](https://github.com/HemingNM/SESraster/issues). The development version of `SESraster` can be installed from the [SESraster repository in Github](https://github.com/HemingNM/SESraster):

```{r, eval = FALSE}
require(devtools)
devtools::install_github("HemingNM/SESraster", build_vignettes = TRUE)
library(SESraster)
```

## Analysis {#analysis}

The `SESraster` package implements functions to randomize presence/absence species distribution raster data with or without including spatial structure for calculating Standardized Effect Sizes (SES) necessary for null hypothesis testing. The function `bootspat_naive()` does not retain the spatial structure of community richness and species distribution size at the same time. It randomizes a raster stack according to the observed frequency of presences for each species (layer) using any of the following methods: sites (raster cells), species (raster layers) or both (layers and cells). This, randomization without retaining spatial structure of data, is the most commonly used method of randomization for community data. The function `bootspat_str()` does retain the spatial structure of community richness and species distribution size at the same time. It randomizes a raster stack keeping the species richness fixed across raster cells. To our knowledge this method was not previously implemented in `R`.

Let's see some examples.

### Random species generation

Now, let's see some of the package features. First, we will create some random species distributions using the package `terra`.

```{r, rand-spp, fig.height=8, fig.width=6}
library(SESraster)
library(terra)
# creating random species distributions
f <- system.file("ex/elev.tif", package="terra")
r <- rast(f)
set.seed(510)
r10 <- rast(lapply(1:18,
                function(i, r, mn, mx){
                  app(r, function(x, t){
                    sapply(x, function(x, t){
                       x<max(t) & x>min(t)
                    }, t=t)
                  }, t=sample(seq(mn, mx), 2))
                }, r=r, mn=minmax(r)[1]+10, mx=minmax(r)[2]-10))

names(r10) <- paste("sp", 1:nlyr(r10))
plot(r10)
```

With the distributions in hand, we can perform the spatial randomizations.

### Spatially Unstructured Randomization

First, let's randomize species distribution ignoring the spatial structure with the function `bootspat_naive`.

#### both, by site and species simultaneously

We can randomize the presences/absences (1s/0s) using the method `both`. This method combines randomization by site and species at the same time. It will shuffle all presences across cells and layers, changing site richness and species distribution sizes and location at the same time. It is equivalent to the SIM1 (equiprobable-equiprobable) method of Gotelli [-@gotelli2000]. Notice that NA cells are ignored.

```{r, naive-both, fig.height=8, fig.width=6}
srb <- bootspat_naive(r10, random = "both")
plot(srb, legend=F)
```

```{r, naive-both-rich, fig.height=4, fig.width=6}
plot(c(sum(r10), sum(srb)), main=c("observed", "randomized"))
```

#### by species

We can randomize by `species`. This second method is performed at each layer (species) of the stack by randomizing the position of species presences in space. If the data fits to the computer RAM memory this randomization is equivalent to the SIM2 (fixed-equiprobable) method of Gotelli [-@gotelli2000] and to the flatland model of Laffan & Crisp [-@laffan2003]. It changes the species richness at each cell while retaining the size of the species distribution (except if randomization is performed by frequency). When running by frequency, presences/absences (1s/0s) are sampled at each pixel based on the probability (frequency) that the species is found within the study area. It is equivalent to the SIM7 (proportional-equiprobable) method of Gotelli [-@gotelli2000]. For each species, the randomized frequency of presences is very similar to the actual frequency but not exactly the same.

```{r, naive-spp, fig.height=8, fig.width=6}
sr1 <- bootspat_naive(r10, random = "species")
plot(sr1, legend=F)
```

```{r, naive-spp-rich, fig.height=4, fig.width=6}
plot(c(sum(r10), sum(sr1)), main=c("observed", "randomized"))
```

```{r, naive-sppb, fig.height=8, fig.width=6}
sr1b <- bootspat_naive(r10, random = "species", memory = FALSE)
```

Check that the number of occupied pixels of randomized distributions are similar to those of the observed distributions.

```{r, table-freq-naive}
cbind(observed=sapply(r10, function(x)freq(x)[2,3]),
      randomized=sapply(sr1, function(x)freq(x)[2,3]),
      randomized_freq=sapply(sr1b, function(x)freq(x)[2,3]))
```

#### by site

Now, we will randomize by `site`. This method randomizes the position (presence/absence) of the species within each site (cell) of the stack. This method keeps species richness constant at each cell but the size of the species distribution might change, as more or less pixels can be randomly assigned to each species (raster layer). This randomization is equivalent to the SIM3 (equiprobable-fixed) method of Gotelli [-@gotelli2000]. Notice that, although the spatial structure of species richness is held constant, the number of pixels that each species occupy is completely randomized.

```{r, naive-site, fig.height=8, fig.width=6}
sr2 <- bootspat_naive(r10, random = "site")
plot(sr2, legend=F)
```

```{r, naive-site-rich, fig.height=4, fig.width=6}
plot(c(sum(r10), sum(sr2)), main=c("observed", "randomized"))
```

### Spatially Structured Randomization

Notice that randomization by `site` from `bootspat_naive` keeps the species richness fixed (i.e. equal to the input raster), but the size of the species' distribution (i.e. number of pixels of each species) is completely randomized. On the other hand, randomization by `species` keeps the number of pixels of each species fixed, but the richness is completely randomized.

In the function `bootspat_str` we implement a spatially structured randomization that keeps the species richness pattern fixed and distribution size of each species, proportional. This method is based on the second null model of Laffan & Crisp [-@laffan2003], but uses probability of sampling presences based on frequency of presences for each species. Therefore, it is equivalent to the SIM5 (proportional-fixed) method of Gotelli [-@gotelli2000]. Notice that it will lack spatial structure in the same way of randomization by `site`, however the size of the species distribution is (nearly) retained.

Randomizations are based on frequencies (given or calculated from the output raster (a presence-absence SpatRaster) and, optionally, a probability raster stack. Both, the frequency vector and the probability raster stack, control the probability that a given species is sampled in each raster cell. The frequency vector controls the probability of sampling each species compared to all others. The probability raster stack controls the probability that each species is sampled on a given raster cell.

```{r}
# bootstrapping once
fr.prob <- SESraster::fr2prob(r10)
prob <- terra::app(r10,
                   function(x){
                     ifelse(is.na(x), 0, 1)
                   })

randr10 <- bootspat_str(r10, rprob = prob, fr_prob = fr.prob)
```

The species distribution was spatially randomized according to the frequency of presence of each species. This method randomizes the position of species presences in space keeping the species richness constant and number of occupied pixels of randomized distributions very similar those on the actual distributions.

```{r, str-site, fig.height=8, fig.width=6}
plot(randr10, legend=F)
```

See unchanged spatial pattern of species richness.

```{r, str-site-rich, fig.height=4, fig.width=6}
plot(c(sum(r10), sum(randr10)), main=c("observed", "randomized"))
```

Check that the number of occupied pixels of randomized distributions are very similar those of the observed distributions.

```{r, table-freq}
cbind(observed=sapply(r10, function(x)freq(x)[2,3]),
      randomized=sapply(randr10, function(x)freq(x)[2,3]))
```

## References {#references}
Gotelli, N. J. (2000). Null Model Analysis of Species Co-Occurrence Patterns. *Ecology*, 81(9), 2606–2621.

Laffan, Shawn W., and Michael D. Crisp. 2003. "Assessing Endemism at Multiple Spatial Scales, with an Example from the Australian Vascular Flora." *Journal of Biogeography* 30(4): 511-520.
